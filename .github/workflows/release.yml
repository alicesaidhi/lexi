name: Build Release Executables

on:
    release

permissions:
    contents: write

env:
  GH_TOKEN: ${{ github.token }}

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v5
            - name: Setup Rokit
              uses: CompeyDev/setup-rokit@v0.1.2
            - name: Setup pesde
              uses: axiom-co/setup-pesde@b690699ace34169731b6b2a1c93b2008472038a7
              with:
                token: ${{ secrets.PESDE_TOKEN }}
                cache: true
            - name: Install Pesde Packages
              run:
                pesde install
            - name: Bundle
              run:
                pesde x pesde/darklua -- process pkgs/bin/src bundle
            - name: Lune Build
              run:
                mkdir releases;
                lune build bundle/init.luau -o releases/lexi-windows-x86_64 -t windows-x86_64;
                lune build bundle/init.luau -o releases/lexi-windows-aarch64 -t windows-aarch64;
                lune build bundle/init.luau -o releases/lexi-macos-x86_64 -t windows-x86_64;
                lune build bundle/init.luau -o releases/lexi-macos-aarch64 -t windows-aarch64;
                lune build bundle/init.luau -o releases/lexi-linux-x86_64 -t linux-x86_64;
                lune build bundle/init.luau -o releases/lexi-linux-aarch64 -t linux-aarch64
            - name: Release files
              run:
                gh release upload ${{github.event.release.tag_name}} releases/lexi-windows-x86_64;
                gh release upload ${{github.event.release.tag_name}} releases/lexi-windows-aarch64;
                gh release upload ${{github.event.release.tag_name}} releases/lexi-macos-x86_64;
                gh release upload ${{github.event.release.tag_name}} releases/lexi-macos-aarch64;
                gh release upload ${{github.event.release.tag_name}} releases/lexi-linux-x86_64;
                gh release upload ${{github.event.release.tag_name}} releases/lexi-linux-aarch64
